#!/usr/bin/env ruby
# frozen_string_literal: true

require 'csv'
require 'fileutils'

# Loads application environment
require_relative '../config'

require 'lib/parser/date_time_parser'
require 'lib/parser/phone_number_parser'
require 'lib/parser/text_parser'

CSV_INPUT_PATH = 'input.csv'
OUTPUT_DIR = 'out'
OUTPUT_FILE_NAME = 'output.csv'
REPORT_FILE_NAME = 'report.txt'

Header = Struct.new(:column, :parser)

HEADER_ROW_METADATA = [
  Header.new('first_name', Parser::TextParser),
  Header.new('last_name', Parser::TextParser),
  Header.new('dob', Parser::DateTimeParser),
  Header.new('member_id', Parser::TextParser),
  Header.new('effective_date', Parser::DateTimeParser),
  Header.new('expiry_date', Parser::DateTimeParser),
  Header.new('phone_number', Parser::TextParser),
]

FileUtils.mkdir_p(OUTPUT_DIR)

CSV.open(File.join(OUTPUT_DIR, OUTPUT_FILE_NAME), "wb") do |out|
  out << HEADER_ROW_METADATA.map(&:column)

  header_consumed = false
  CSV.foreach(CSV_INPUT_PATH) do |row|
    unless header_consumed
      header_consumed = true
      next
    end

    out << row.map.with_index do |value, index|
      HEADER_ROW_METADATA[index].parser.parse(value)
    end
  end
end

File.open(File.join(OUTPUT_DIR, REPORT_FILE_NAME), 'wb') do |file|
  file << 'TODO implement report!'
end
